<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°€ê²Œ ìƒì„¸ì •ë³´</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            padding: 0;
            margin: 0;
            background-color: #f4f4f4;
        }

        .store-info {
            max-width: 600px;
            margin: 40px auto 0;
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .store-info img {
            width: 100%;
            max-height: 250px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .store-info h2 {
            margin: 0;
            color: #ff4d4f;
        }

        .store-info p {
            margin: 8px 0;
        }

        .back-btn {
            margin-top: 20px;
            padding: 10px 16px;
            border: none;
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- ê³µí†µ í—¤ë” ì˜ì—­ -->
<div id="header"></div>

<!-- ê°€ê²Œ ìƒì„¸ ì •ë³´ -->
<div class="store-info" id="store-info"></div>

<div id="menu-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999;">
    <div style="background:white; width:350px; margin:100px auto; padding:20px; border-radius:10px; position: relative;">
        <span onclick="closeMenuModal()" style="position:absolute; top:10px; right:15px; font-weight:bold; cursor:pointer;">Ã—</span>
        <h3>ğŸ± ë©”ë‰´ ë“±ë¡</h3>
        <input type="text" id="menu-name" placeholder="ë©”ë‰´ëª…" style="width:90%; margin:10px 0; padding:8px;"><br>
        <input type="number" id="menu-price" placeholder="ê°€ê²© (ì›)" style="width:90%; margin:10px 0; padding:8px;"><br>
        <input type="text" id="menu-category" placeholder="ì¹´í…Œê³ ë¦¬ (ì˜ˆ: í•œì‹)" style="width:90%; margin:10px 0; padding:8px;"><br>
        <textarea id="menu-content" placeholder="ë©”ë‰´ ì„¤ëª…" style="width:90%; margin:10px 0; padding:8px;"></textarea><br>
        <input type="file" id="menu-picture"><br><br>
        <button onclick="submitMenu()" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:6px;">ë“±ë¡í•˜ê¸°</button>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const storeId = params.get("storeId");
    const token = localStorage.getItem("accessToken");

    if (!token || !storeId) {
        alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
        window.location.href = "/home.html";
    }

    function parseJwt(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
            '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));

        return JSON.parse(jsonPayload);
    }

    const roles = parseJwt(token).roles || [];
    const isOwner = roles.includes("OWNER");

    // ê°€ê²Œ ìƒì„¸ ì¡°íšŒ
    fetch(`/api/stores/${storeId}`, {
        method: "GET",
        headers: { Authorization: "Bearer " + token }
    })
        .then(res => res.json())
        .then(result => {
            const store = result.data;
            const div = document.getElementById("store-info");

            div.innerHTML = `
            <img src="${store.menus?.[0]?.menuPicture || '/logos/default-store.jpg'}" alt="ëŒ€í‘œ ì´ë¯¸ì§€">
            <h2>${store.store_name}</h2>
            <p><strong>ì¹´í…Œê³ ë¦¬:</strong> ${store.food_category}</p>
            <p><strong>ì£¼ì†Œ:</strong> ${store.store_address}</p>
            <p><strong>ì „í™”ë²ˆí˜¸:</strong> ${store.store_phone}</p>
            <p><strong>ì†Œê°œ:</strong> ${store.store_intro || '-'}</p>
            <p><strong>ë°°ë‹¬ ìµœì†Œ ê¸ˆì•¡:</strong> ${store.min_delivery_price.toLocaleString()}ì›</p>
            <p><strong>ë°°ë‹¬íŒ:</strong> ${store.delivery_tip.toLocaleString()}ì›</p>
            <p><strong>ë³„ì :</strong> ${store.rating} â­ (${store.review_count}ê°œ ë¦¬ë·°)</p>
            <p><strong>ìš´ì˜ì‹œê°„:</strong> ${store.open_time} ~ ${store.close_time}</p>
            ${isOwner ? `<button class="back-btn" onclick="openMenuModal()">ğŸ± ë©”ë‰´ ì¶”ê°€</button>` : ''}
            <button class="back-btn" onclick="history.back()">ëŒì•„ê°€ê¸°</button>
        `;
        })
        .catch(err => {
            console.error("ê°€ê²Œ ìƒì„¸ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:", err);
            alert("ê°€ê²Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        });


    // 2. ê³µí†µ í—¤ë” ë¶ˆëŸ¬ì˜¤ê¸° + ìœ ì €/ìœ„ì¹˜ í‘œì‹œ
    (async () => {
        try {
            const headerHtml = await fetch('header.html').then(res => res.text());
            document.getElementById("header").innerHTML = headerHtml;

            const profileRes = await fetch("/api/auth/profiles/me", {
                headers: { Authorization: "Bearer " + token }
            });
            const profileData = await profileRes.json();
            const nickname = profileData.data.nickname;

            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    try {
                        const regionRes = await fetch(`/api/region?lat=${lat}&lng=${lng}`);
                        const region = await regionRes.json();
                        document.getElementById("user-info").innerText = `${nickname} | ${region.region}`;
                        document.getElementById("logo").src = region.logo_url;
                    } catch {
                        document.getElementById("user-info").innerText = `${nickname} | ì§€ì—­ ì •ë³´ ì‹¤íŒ¨`;
                    }
                },
                () => {
                    document.getElementById("user-info").innerText = `${nickname} | ìœ„ì¹˜ ê¶Œí•œ í•„ìš”`;
                }
            );
        } catch (err) {
            console.error("í—¤ë” ë¡œë”© ì‹¤íŒ¨:", err);
        }
    })();

    function openMenuModal() {
        document.getElementById("menu-modal").style.display = "block";
    }

    function closeMenuModal() {
        document.getElementById("menu-modal").style.display = "none";
    }

    function submitMenu() {
        const name = document.getElementById("menu-name").value.trim();
        const price = parseInt(document.getElementById("menu-price").value.trim(), 10);
        const category = document.getElementById("menu-category").value.trim();
        const content = document.getElementById("menu-content").value.trim();
        const picture = document.getElementById("menu-picture").files[0];

        if (!name || !price || !category || !content) {
            alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const formData = new FormData();
        formData.append("menuName", name);
        formData.append("price", price);
        formData.append("category", category);
        formData.append("menuContent", content);
        formData.append("menuPicture", picture);

        fetch(`/api/stores/${storeId}/menus`, {
            method: "POST",
            headers: {
                Authorization: "Bearer " + token
            },
            body: formData
        })
            .then(res => {
                if (!res.ok) throw new Error("ë“±ë¡ ì‹¤íŒ¨");
                return res.json();
            })
            .then(data => {
                alert("ë©”ë‰´ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeMenuModal();
                window.location.reload();
            })
            .catch(err => alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message));
    }

</script>

</body>
</html>
