<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 50px;
        }
        h1 {
            color: #ff4d4f;
            margin-bottom: 30px;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 30px;
            width: 400px;
            text-align: center;
        }
        .info {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-edit {
            background-color: #ffa500;
            color: white;
        }
        .btn-logout {
            background-color: #ff4d4f;
            color: white;
        }
        .btn-business {
            background-color: #007bff;
            color: white;
            display: none;
        }
        .btn-delete {
            background-color: #6c757d;
            color: white;
        }

    </style>
</head>
<body>

<h1>ë§ˆì´í˜ì´ì§€</h1>

<div class="card">
    <div id="user-info" class="info">ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <button class="btn btn-edit" onclick="openEditModal()">âš™ ì •ë³´ ìˆ˜ì •</button>
    <button class="btn btn-edit" onclick="openPasswordModal()">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    <button class="btn btn-business" id="open-business-modal" onclick="openBusinessModal()">ğŸ“¦ ì‚¬ì—…ì ë“±ë¡</button>
    <button class="btn btn-logout" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>

</div>

<!-- í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ -->
<button onclick="location.href='home.html'"
        style="margin-top: 20px; padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
    â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
</button>

<button class="btn btn-delete" onclick="openWithdrawModal()">ğŸ’¥ íšŒì› íƒˆí‡´</button>

<!-- ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="edit-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999;">
    <div style="background:white; width:300px; margin:100px auto; padding:20px; border-radius:10px; position: relative;">
        <span onclick="closeEditModal()" style="position:absolute; top:10px; right:15px; font-weight:bold; cursor:pointer;">&times;</span>
        <h3>ì •ë³´ ìˆ˜ì •</h3>
        <input type="text" id="edit-nickname" placeholder="ë‹‰ë„¤ì„" style="width:90%; margin:10px 0; padding:8px;"><br>
        <input type="text" id="edit-address" placeholder="ì£¼ì†Œ" style="width:90%; margin:10px 0; padding:8px;"><br>
        <button onclick="submitEdit()" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:6px;">ìˆ˜ì •í•˜ê¸°</button>
    </div>
</div>

<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
<div id="password-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999;">
    <div style="background:white; width:300px; margin:100px auto; padding:20px; border-radius:10px; position: relative;">
        <span onclick="closePasswordModal()" style="position:absolute; top:10px; right:15px; font-weight:bold; cursor:pointer;">&times;</span>
        <h3>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>

        <input type="password" id="current-password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" style="width:90%; margin:10px 0; padding:8px;"><br>
        <input type="password" id="new-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" style="width:90%; margin:10px 0; padding:8px;"><br>
        <input type="password" id="confirm-new-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" style="width:90%; margin:10px 0; padding:8px;"><br>

        <button onclick="submitPasswordChange()" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:6px;">ë³€ê²½í•˜ê¸°</button>
    </div>
</div>

<!-- ì‚¬ì—…ì ë“±ë¡ ëª¨ë‹¬ -->
<div id="business-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999;">
    <div style="background:white; width:300px; margin:100px auto; padding:20px; border-radius:10px; position: relative;">
        <span onclick="closeBusinessModal()" style="position:absolute; top:10px; right:15px; font-weight:bold; cursor:pointer;">&times;</span>
        <h3>ì‚¬ì—…ì ì‹ ì²­</h3>
        <input type="text" id="owner-name" placeholder="ì‚¬ì—…ìëª…" style="width:90%; margin:10px 0; padding:8px;"><br>
        <input type="text" id="registration-number" placeholder="123-45-67890" style="width:90%; margin:10px 0; padding:8px;"><br>
        <button onclick="submitBusinessApplication()" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:6px;">ì‹ ì²­í•˜ê¸°</button>
    </div>
</div>

<!-- íšŒì› íƒˆí‡´ ëª¨ë‹¬ -->
<div id="withdraw-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999;">
    <div style="background:white; width:300px; margin:100px auto; padding:20px; border-radius:10px; position: relative;">
        <span onclick="closeWithdrawModal()" style="position:absolute; top:10px; right:15px; font-weight:bold; cursor:pointer;">Ã—</span>
        <h3>ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ íƒˆí‡´</h3>
        <input type="password" id="withdraw-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="width:90%; margin:10px 0; padding:8px;"><br>
        <button onclick="submitWithdraw()" style="padding:8px 16px; background:#ff4d4f; color:white; border:none; border-radius:6px;">íƒˆí‡´í•˜ê¸°</button>
    </div>
</div>

<script>
    let memberId;

    const token = localStorage.getItem('accessToken');

    if (!token) {
        alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        window.location.href = "/index.html";
    } else {
        fetch('/api/auth/profiles/me', {
            method: 'GET',
            headers: { Authorization: 'Bearer ' + token }
        })
            .then(res => res.json())
            .then(data => {
                const user = data.data;
                memberId = user.id;
                document.getElementById("user-info").innerText =
                    `ğŸ‘¤ ${user.nickname} (${user.email})\nğŸ“ ${user.address}\nì—­í• : ${user.role}`;

                if (user.role === "USER") {
                    document.getElementById("open-business-modal").style.display = "inline-block";
                }
            })
            .catch(err => {
                alert("ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: " + err.message);
            });
    }

    function logout() {
        fetch('/api/auth/logout', {
            method: 'POST',
            headers: { Authorization: 'Bearer ' + token }
        })
            .then(() => {
                localStorage.clear();
                alert("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ!");
                window.location.href = "/index.html";
            })
            .catch(() => {
                localStorage.clear();
                alert("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜! í•˜ì§€ë§Œ ê°•ì œ ì¢…ë£Œí•©ë‹ˆë‹¤.");
                window.location.href = "/index.html";
            });
    }

    function openEditModal() {
        document.getElementById("edit-modal").style.display = "block";
    }

    function closeEditModal() {
        document.getElementById("edit-modal").style.display = "none";
    }

    function submitEdit() {
        const nickname = document.getElementById("edit-nickname").value;
        const address = document.getElementById("edit-address").value;

        if (!nickname || !address) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        if (!memberId) return alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

        fetch(`/api/auth/profiles/${memberId}`, {
            method: "PATCH",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ nickname, address })
        })
            .then(res => {
                if (!res.ok) throw new Error("ìˆ˜ì • ì‹¤íŒ¨");
                alert("ì •ë³´ ìˆ˜ì • ì™„ë£Œ!");
                closeEditModal();
                window.location.reload();
            })
            .catch(err => alert("ìˆ˜ì • ì˜¤ë¥˜: " + err.message));
    }

    function openBusinessModal() {
        document.getElementById("business-modal").style.display = "block";
    }

    function closeBusinessModal() {
        document.getElementById("business-modal").style.display = "none";
    }

    function submitBusinessApplication() {
        const ownerName = document.getElementById("owner-name").value.trim();
        const registrationNumber = document.getElementById("registration-number").value.trim();

        if (!ownerName || !registrationNumber) {
            alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch("/api/auth/business/apply", {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ ownerName, registrationNumber })
        })
            .then(res => res.json())
            .then(data => {
                alert("ì‚¬ì—…ì ì‹ ì²­ ì™„ë£Œ: " + data.message);
                closeBusinessModal();
            })
            .catch(err => alert("ì‹ ì²­ ì‹¤íŒ¨: " + err.message));
    }

    function openPasswordModal() {
        document.getElementById("password-modal").style.display = "block";
    }

    function closePasswordModal() {
        document.getElementById("password-modal").style.display = "none";
    }

    function submitPasswordChange() {
        const currentPassword = document.getElementById("current-password").value.trim();
        const newPassword = document.getElementById("new-password").value.trim();
        const confirmNewPassword = document.getElementById("confirm-new-password").value.trim();

        if (!currentPassword || !newPassword || !confirmNewPassword) {
            alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (newPassword !== confirmNewPassword) {
            alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        if (!memberId) {
            alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            return;
        }

        fetch(`/api/auth/profiles/${memberId}/password`, {
            method: "PATCH",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                currentPassword,
                newPassword,
                confirmNewPassword
            })
        })
            .then(res => {
                if (!res.ok) throw new Error("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨");
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closePasswordModal();
            })
            .catch(err => {
                alert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì˜¤ë¥˜: " + err.message);
            });
    }
    function openWithdrawModal() {
        document.getElementById("withdraw-modal").style.display = "block";
    }

    function closeWithdrawModal() {
        document.getElementById("withdraw-modal").style.display = "none";
    }

    function submitWithdraw() {
        const password = document.getElementById("withdraw-password").value.trim();
        if (!password) {
            alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (!confirm("ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch("/api/auth/users/me", {
            method: "DELETE",
            headers: {
                "Authorization": "Bearer " + token
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("íƒˆí‡´ ì‹¤íŒ¨");
                alert("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                localStorage.clear();
                window.location.href = "/index.html";
            })
            .catch(err => {
                alert("íƒˆí‡´ ì˜¤ë¥˜: " + err.message);
            });
    }

</script>

</body>
</html>
