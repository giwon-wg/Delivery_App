<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì£¼ë¬¸ ëª©ë¡</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .order-card {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .order-card p {
            margin: 5px 0;
        }
        .approve-btn, .reject-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 8px;
        }
        .approve-btn { background-color: green; color: white; }
        .reject-btn { background-color: red; color: white; }
    </style>
</head>
<body>
<div id="business-header"></div>

<div id="store-name" style="margin-bottom: 20px; font-weight: bold;"></div>
<div id="order-list"></div>

<script>
    (async () => {
        try {
            const headerHtml = await fetch('business-header.html').then(res => res.text());
            document.getElementById("business-header").innerHTML = headerHtml;
        } catch (err) {
            console.error("ì‚¬ì—…ì í—¤ë” ë¡œë”© ì‹¤íŒ¨", err);
        }
    })();

    const token = localStorage.getItem("accessToken");
    if (!token) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "/index.html";
    }

    const storeId = new URLSearchParams(window.location.search).get("storeId");
    if (!storeId) {
        alert("storeIdê°€ ì—†ìŠµë‹ˆë‹¤.");
        window.location.href = "/home.html";
    }

    let menuMap = {};

    function loadOrderList() {
        fetch(`/api/orders/store/${storeId}`, {
            headers: { Authorization: `Bearer ${token}` }
        })
            .then(res => res.json())
            .then(data => {
                const orders = data.data || [];
                const orderListDiv = document.getElementById("order-list");
                orderListDiv.innerHTML = "";

                if (orders.length === 0) {
                    orderListDiv.innerHTML = "<p>ë“±ë¡ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                    return;
                }

                orders.forEach(order => {
                    const card = document.createElement("div");
                    card.className = "order-card";

                    const totalPrice = order.total_price; // ì—¬ê¸° ìˆ˜ì •!!

                    card.innerHTML = `
                        <p><strong>ì£¼ë¬¸ ID:</strong> ${order.order_id}</p>
                        <p><strong>ë©”ë‰´:</strong> ${menuMap[order.menu_id] || 'ë©”ë‰´ ì´ë¦„ ì—†ìŒ'}</p>
                        <p><strong>ìƒíƒœ:</strong> ${translateStatus(order.status)}</p>
                        <p><strong>ì´ ê¸ˆì•¡:</strong> ${totalPrice != null ? totalPrice.toLocaleString() + "ì›" : "ì •ë³´ ì—†ìŒ"}</p>
                        ${order.status === 'REQUESTED' ? `
                            <button class="approve-btn" onclick="updateOrderStatus(${order.order_id}, 'accept')">ìŠ¹ì¸</button>
                            <button class="reject-btn" onclick="updateOrderStatus(${order.order_id}, 'reject')">ê±°ì ˆ</button>
                        ` : ''}
                    `;
                    orderListDiv.appendChild(card);
                });
            })
            .catch(err => {
                console.error("ì£¼ë¬¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨", err);
                alert("ì£¼ë¬¸ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            });
    }

    function loadStoreInfo() {
        fetch(`/api/stores/${storeId}`, {
            headers: { Authorization: `Bearer ${token}` }
        })
            .then(res => res.json())
            .then(data => {
                document.getElementById("store-name").innerText = `ğŸª ${data.data.store_name}`;

                // ë©”ë‰´ ì´ë¦„ ë§¤í•‘ìš©
                (data.data.menus || []).forEach(menu => {
                    menuMap[menu.id] = menu.menu_name;
                });

                loadOrderList();
            })
            .catch(err => {
                console.error("ê°€ê²Œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", err);
            });
    }

    function translateStatus(status) {
        switch(status) {
            case "REQUESTED": return "ìš”ì²­ë¨";
            case "ACCEPTED": return "ìˆ˜ë½ë¨";
            case "DELIVERED": return "ë°°ë‹¬ì™„ë£Œ";
            default: return status;
        }
    }

    function updateOrderStatus(orderId, action) {
        fetch(`/api/orders/${orderId}/${action}`, {
            method: "PATCH",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            }
        })
            .then(res => res.json())
            .then(() => {
                alert(`ì£¼ë¬¸ì´ ${action === 'accept' ? 'ìŠ¹ì¸' : 'ê±°ì ˆ'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                loadOrderList();
            })
            .catch(err => {
                console.error("ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨", err);
                alert("ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
    }

    window.onload = loadStoreInfo;
</script>

</body>
</html>