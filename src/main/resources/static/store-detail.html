<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°€ê²Œ ìƒì„¸ì •ë³´</title>
    <style>

        /* ëª¨ë‹¬ ì•ˆ ëª¨ë“  ë²„íŠ¼ */
        #edit-menu-modal button,
        #store-edit-modal button,
        #store-time-modal button,
        #menu-detail-modal button,
        #edit-option-modal button,
        #add-option-modal button {
            cursor: pointer;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .store-info {
            max-width: 600px;
            margin: 40px auto;
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .store-info img {
            width: 100%;
            max-height: 250px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .store-info h2 {
            margin: 0;
            color: #ff4d4f;
        }

        .store-info p {
            margin: 8px 0;
        }

        .back-btn {
            margin-top: 20px;
            padding: 10px 16px;
            border: none;
            background-color: #007bff;
            color: white;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
        }

        .menu-wrapper {
            margin-top: 40px;
        }

        .menu-card {
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            gap: 14px;
            align-items: center;
        }

        .menu-card img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .menu-info {
            flex: 1;
        }

        .menu-info h4 {
            margin: 0;
            font-size: 1rem;
        }

        .menu-info p {
            margin: 4px 0 0;
            font-size: 0.9rem;
            color: #555;
        }

        .edit-btn {
            padding: 6px 10px;
            background-color: #ffa500;
            color: white;
            font-size: 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        #header {
            padding: 16px 24px;
        }

    </style>
</head>
<body>

<div id="header"></div>

<div class="store-info" id="store-info"></div>

<div id="menu-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999;">
    <div style="background:white; width:350px; margin:100px auto; padding:20px; border-radius:10px; position: relative;">
        <span onclick="closeMenuModal()" style="position:absolute; top:10px; right:15px; font-weight:bold; cursor:pointer;">Ã—</span>
        <h3>ğŸ± ë©”ë‰´ ë“±ë¡</h3>
        <input type="text" id="menu-name" placeholder="ë©”ë‰´ëª…" style="width:90%; margin:10px 0; padding:8px;"><br>
        <input type="number" id="menu-price" placeholder="ê°€ê²© (ì›)" style="width:90%; margin:10px 0; padding:8px;"><br>
        <input type="text" id="menu-category" placeholder="ì¹´í…Œê³ ë¦¬ (ì˜ˆ: í•œì‹)" style="width:90%; margin:10px 0; padding:8px;"><br>
        <textarea id="menu-content" placeholder="ë©”ë‰´ ì„¤ëª…" style="width:90%; margin:10px 0; padding:8px;"></textarea><br>
        <input type="text" id="menu-picture" placeholder="ì´ë¯¸ì§€ ì£¼ì†Œ ì…ë ¥ (ì˜ˆ: https://example.com/image.jpg)" style="width:90%; margin:10px 0; padding:8px;"><br><br>
        <button onclick="submitMenu()" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:6px;">ë“±ë¡í•˜ê¸°</button>
    </div>
</div>

<div id="edit-menu-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999;">
    <div style="background:white; width:350px; margin:100px auto; padding:20px; border-radius:10px; position: relative;">
        <span onclick="closeEditMenuModal()" style="position:absolute; top:10px; right:15px; font-weight:bold; cursor:pointer;">Ã—</span>
        <h3>âœï¸ ë©”ë‰´ ìˆ˜ì •</h3>
        <input type="hidden" id="edit-menu-id">
        <input type="text" id="edit-menu-name" placeholder="ë©”ë‰´ëª…" style="width:90%; margin:10px 0; padding:8px;"><br>
        <input type="number" id="edit-menu-price" placeholder="ê°€ê²© (ì›)" style="width:90%; margin:10px 0; padding:8px;"><br>
        <!--        <input type="text" id="edit-menu-category" placeholder="ì¹´í…Œê³ ë¦¬" style="width:90%; margin:10px 0; padding:8px;"><br>-->
        <textarea id="edit-menu-content" placeholder="ë©”ë‰´ ì„¤ëª…" style="width:90%; margin:10px 0; padding:8px;"></textarea><br>
        <!--        <input type="text" id="edit-menu-picture" placeholder="ì´ë¯¸ì§€ ì£¼ì†Œ" style="width:90%; margin:10px 0; padding:8px;"><br>-->
        <button onclick="submitMenuEdit()" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:6px;">ìˆ˜ì •í•˜ê¸°</button>
        <button onclick="submitMenuDelete()" style="padding:8px 16px; background:#dc3545; color:white; border:none; border-radius:6px; margin-left: 10px;">ì‚­ì œí•˜ê¸°</button>
    </div>
</div>

<!-- ê°€ê²Œ ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="store-edit-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index:999;">
    <div style="background:white; width:600px; margin:100px auto; padding:24px 32px; border-radius:10px; position:relative;">
    <span onclick="document.getElementById('store-edit-modal').style.display='none'" style="position:absolute; top:10px; right:15px; font-weight:bold; cursor:pointer;">Ã—</span>
        <h3>ğŸª ê°€ê²Œ ì •ë³´ ìˆ˜ì •</h3>
        <input id="edit-store-name" placeholder="ê°€ê²Œëª…" style="width:100%; margin:10px 0; padding:8px;">
        <input id="edit-store-address" placeholder="ì£¼ì†Œ" style="width:100%; margin:10px 0; padding:8px;">
        <input id="edit-food-category" placeholder="ì¹´í…Œê³ ë¦¬" style="width:100%; margin:10px 0; padding:8px;">
        <input id="edit-store-phone" placeholder="ì „í™”ë²ˆí˜¸" style="width:100%; margin:10px 0; padding:8px;">
        <textarea id="edit-store-intro" placeholder="ì†Œê°œ" style="width:100%; margin:10px 0; padding:8px;"></textarea>
        <input id="edit-min-price" type="number" placeholder="ìµœì†Œ ë°°ë‹¬ê¸ˆì•¡" style="width:100%; margin:10px 0; padding:8px;">
        <input id="edit-delivery-tip" type="number" placeholder="ë°°ë‹¬íŒ" style="width:100%; margin:10px 0; padding:8px;">
        <button onclick="submitStoreEdit()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:6px;">ìˆ˜ì •í•˜ê¸°</button>
    </div>
</div>

<!-- ì˜ì—…ì‹œê°„ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="store-time-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index:999;">
    <div style="background:white; width:350px; margin:100px auto; padding:20px; border-radius:10px; position: relative;">
        <span onclick="document.getElementById('store-time-modal').style.display='none'" style="position:absolute; top:10px; right:15px; font-weight:bold; cursor:pointer;">Ã—</span>
        <h3>â° ì˜ì—…ì‹œê°„ ìˆ˜ì •</h3>
        <input id="edit-open-time" placeholder="ì˜¤í”ˆì‹œê°„ (ì˜ˆ: 08:00)" style="width:100%; margin:10px 0; padding:8px;">
        <input id="edit-close-time" placeholder="ë§ˆê°ì‹œê°„ (ì˜ˆ: 22:00)" style="width:100%; margin:10px 0; padding:8px;">
        <button onclick="submitTimeEdit()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:6px;">ìˆ˜ì •í•˜ê¸°</button>
    </div>
</div>

<!-- ë©”ë‰´ ìƒì„¸ ëª¨ë‹¬ -->
<div id="menu-detail-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index:999;">
    <div style="background:white; width:400px; margin:50px auto; padding:20px; border-radius:10px; position:relative;">
        <span onclick="closeMenuDetailModal()" style="position:absolute; top:10px; right:15px; font-weight:bold; cursor:pointer;">Ã—</span>

        <h3 id="detail-menu-name">ğŸ± ë©”ë‰´ ìƒì„¸</h3>
        <p id="detail-menu-content" style="color:#555;"></p>

        <h4>ì˜µì…˜ ëª©ë¡</h4>
        <div id="option-list" style="margin-top:10px;"></div>

        <button id="order-button" style="margin-top: 12px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">
            ğŸ›’ ì£¼ë¬¸í•˜ê¸°
        </button>

        <!-- OWNERë¼ë©´ ì˜µì…˜ ì¶”ê°€ ë²„íŠ¼ í‘œì‹œ -->
        <div id="option-action" style="margin-top:20px;">
            <!-- ì—¬ê¸°ì— ì¶”ê°€ ë²„íŠ¼ì´ ë™ì ìœ¼ë¡œ ë“¤ì–´ê° -->
        </div>

    </div>
</div>

<!-- ì˜µì…˜ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="edit-option-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;">
    <div style="background:white; width:400px; margin:100px auto; padding:20px; border-radius:10px; position:relative;">
        <span onclick="closeEditOptionModal()" style="position:absolute; top:10px; right:15px; font-weight:bold; cursor:pointer;">Ã—</span>
        <h3>ì˜µì…˜ ìˆ˜ì •</h3>
        <input id="edit-option-name" placeholder="ì˜µì…˜ ì´ë¦„" style="width:100%; margin:10px 0; padding:8px;">
        <input id="edit-option-price" type="number" placeholder="ê°€ê²©" style="width:100%; margin:10px 0; padding:8px;">
        <textarea id="edit-option-content" placeholder="ì„¤ëª…" style="width:100%; margin:10px 0; padding:8px;"></textarea>
        <button onclick="submitOptionEdit()" style="margin-top:10px; padding:10px 20px; background:#28a745; color:white; border:none; border-radius:6px;">ìˆ˜ì •í•˜ê¸°</button>
    </div>
</div>

<!-- ì˜µì…˜ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="add-option-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;">
    <div style="background:white; width:500px; margin:100px auto; padding:24px 32px; border-radius:10px; position:relative;">
        <span onclick="closeAddOptionModal()" style="position:absolute; top:10px; right:15px; font-weight:bold; cursor:pointer;">Ã—</span>
        <h3>ì˜µì…˜ ì¶”ê°€</h3>
        <input id="add-option-name" placeholder="ì˜µì…˜ ì´ë¦„" style="width:100%; margin:10px 0; padding:8px;">
        <input id="add-option-price" type="number" placeholder="ê°€ê²©" style="width:100%; margin:10px 0; padding:8px;">
        <textarea id="add-option-content" placeholder="ì„¤ëª…" style="width:100%; margin:10px 0; padding:8px;"></textarea>
        <button onclick="submitOptionAdd()" style="margin-top:10px; padding:10px 20px; background:#007bff; color:white; border:none; border-radius:6px;">ì¶”ê°€í•˜ê¸°</button>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const storeId = params.get("storeId");
    const token = localStorage.getItem("accessToken");

    if (!token || !storeId) {
        alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
        window.location.href = "/home.html";
    }

    function parseJwt(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
            '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
    }

    const roles = parseJwt(token).roles || [];
    const isOwner = roles.includes("OWNER");

    fetch(`/api/stores/${storeId}`, {
        method: "GET",
        headers: { Authorization: "Bearer " + token }
    })
        .then(res => res.json())
        .then(result => {
            const store = result.data;
            const div = document.getElementById("store-info");

            let html = `
            <img src="${store.menus?.[0]?.menu_picture || '/logos/default-store.jpg'}" alt="ëŒ€í‘œ ì´ë¯¸ì§€">
            <h2>${store.store_name}</h2>
            <p><strong>ì¹´í…Œê³ ë¦¬:</strong> ${store.food_category}</p>
            <p><strong>ì£¼ì†Œ:</strong> ${store.store_address}</p>
            <p><strong>ì „í™”ë²ˆí˜¸:</strong> ${store.store_phone}</p>
            <p><strong>ì†Œê°œ:</strong> ${store.store_intro || '-'}</p>
            <p><strong>ë°°ë‹¬ ìµœì†Œ ê¸ˆì•¡:</strong> ${store.min_delivery_price.toLocaleString()}ì›</p>
            <p><strong>ë°°ë‹¬íŒ:</strong> ${store.delivery_tip.toLocaleString()}ì›</p>
            <p><strong>ë³„ì :</strong> ${store.rating} â­ (${store.review_count}ê°œ ë¦¬ë·°)</p>
            <p><strong>ìš´ì˜ì‹œê°„:</strong> ${store.open_time} ~ ${store.close_time}</p>
            ${isOwner ? `
                <button class="back-btn" onclick="openMenuModal()">ë©”ë‰´ ì¶”ê°€</button>
                <button class="back-btn" onclick="openStoreEditModal()">ê°€ê²Œ ì •ë³´ ìˆ˜ì •</button>
                <button class="back-btn" onclick="openTimeEditModal()">ì˜ì—…ì‹œê°„ ìˆ˜ì •</button>
                <button class="back-btn" style="background-color: #dc3545;" onclick="deleteStore()">ê°€ê²Œ íì—…</button>
                <button onclick="openOrderListPage()" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 6px;">
        ğŸ“ ì£¼ë¬¸ ëª©ë¡
    </button>
            ` : ''}
            <button class="back-btn" onclick="history.back()">â† ëŒì•„ê°€ê¸°</button>
            <div class="menu-wrapper">
                <h3>ğŸ“‹ ë©”ë‰´</h3>
                <div style="margin-bottom: 20px;">
                    <input id="menu-search" type="text" placeholder="ë©”ë‰´ ê²€ìƒ‰..."
                    style="width: 100%; padding: 10px; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc;">
                </div>
        `;

            if (store.menus && store.menus.length > 0) {
                store.menus.forEach(menu => {
                    html += `
                <div style="margin-bottom: 20px;">
                    <div class="menu-card" onclick="openMenuDetailModal(${menu.id}, '${menu.menu_name}', '${menu.menu_content}')" style="cursor: pointer;">
                        <img src="${menu.menu_picture || '/logos/default-menu.png'}" alt="ë©”ë‰´ ì´ë¯¸ì§€">
                        <div class="menu-info">
                            <h4>${menu.menu_name} - ${menu.price.toLocaleString()}ì›</h4>
                            <p>${menu.menu_content || '-'}</p>
                        </div>
                    </div>
                    ${isOwner ? `
                        <div style="margin-top: 8px; text-align: right;">
                            <button class="edit-btn" onclick="openEditMenuModal(${menu.id}, '${menu.menu_name}', ${menu.price}, '${menu.menu_content}')">
                                ë©”ë‰´ ìˆ˜ì •
                            </button>
                        </div>
                    ` : ''}
                </div>
                `;
                });
            } else {
                html += `<p>ë“±ë¡ëœ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }

            html += `</div>`; // menu-wrapper ë‹«ê¸°
            div.innerHTML = html;

            const searchInput = document.getElementById('menu-search');
            searchInput.addEventListener('keyup', function() {
                const keyword = this.value.toLowerCase();
                const menuCards = document.querySelectorAll('.menu-card');
                menuCards.forEach(card => {
                    const menuName = card.querySelector('h4').innerText.toLowerCase();
                    if (menuName.includes(keyword)) {
                        card.parentElement.style.display = '';
                    } else {
                        card.parentElement.style.display = 'none';
                    }
                });
            });
        });



    // ë©”ë‰´ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    function openMenuModal() {
        document.getElementById("menu-modal").style.display = "block";
    }

    function closeMenuModal() {
        document.getElementById("menu-modal").style.display = "none";
    }

    function submitMenu() {
        const token = localStorage.getItem("accessToken");
        const name = document.getElementById("menu-name").value.trim();
        const price = parseInt(document.getElementById("menu-price").value.trim(), 10);
        const category = document.getElementById("menu-category").value.trim();
        const content = document.getElementById("menu-content").value.trim();
        const picture = document.getElementById("menu-picture").value.trim();

        if (!name || !price || !category || !content) {
            alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const requestBody = {
            menuName: name,
            price,
            category,
            menuContent: content,
            menuPicture: picture
        };

        fetch(`/api/stores/${storeId}/menus`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestBody)
        })
            .then(res => {
                if (!res.ok) throw new Error("ë³¸ì¸ ì†Œìœ ì˜ ê°€ê²Œë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return res.json();
            })
            .then(() => {
                alert("ë©”ë‰´ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeMenuModal();
                window.location.reload();
            })
            .catch(err => alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message));
    }

    function editMenu(menuId) {
        alert("ìˆ˜ì • ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (menuId: " + menuId + ")");
        // ë‚˜ì¤‘ì— ëª¨ë‹¬ ë˜ëŠ” ìˆ˜ì • í˜ì´ì§€ë¡œ ì—°ê²°í•  ìˆ˜ ìˆìŒ
    }

    // í—¤ë” ë¶ˆëŸ¬ì˜¤ê¸°
    (async () => {
        try {
            const headerHtml = await fetch('header.html').then(res => res.text());
            document.getElementById("header").innerHTML = headerHtml;
        } catch (err) {
            console.error("í—¤ë” ë¡œë”© ì‹¤íŒ¨:", err);
        }
    })();

    function openEditMenuModal(id, name, price, content) {


        document.getElementById("edit-menu-id").value = id;
        document.getElementById("edit-menu-name").value = name;
        document.getElementById("edit-menu-price").value = price;
        // document.getElementById("edit-menu-category").value = category;
        document.getElementById("edit-menu-content").value = content;
        // document.getElementById("edit-menu-picture").value = picture;
        document.getElementById("edit-menu-modal").style.display = "block";
    }

    function closeEditMenuModal() {
        document.getElementById("edit-menu-modal").style.display = "none";
    }

    function submitMenuEdit() {
        const id = document.getElementById("edit-menu-id").value;
        const token = localStorage.getItem("accessToken");

        const body = {
            menuName: document.getElementById("edit-menu-name").value.trim(),
            price: parseInt(document.getElementById("edit-menu-price").value),
            menuContent: document.getElementById("edit-menu-content").value.trim()
        };

        fetch(`/api/stores/${storeId}/menus/${id}`, {
            method: "PATCH",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        })
            .then(res => {
                if (!res.ok) throw new Error("ë³¸ì¸ ì†Œìœ ì˜ ê°€ê²Œë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return res.json();
            })
            .then(() => {
                alert("ë©”ë‰´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeEditMenuModal();
                window.location.reload();
            })
            .catch(err => alert("ì˜¤ë¥˜: " + err.message));
    }

    function submitMenuDelete() {
        const id = document.getElementById("edit-menu-id").value;
        const token = localStorage.getItem("accessToken");

        if (!confirm("ì •ë§ ì´ ë©”ë‰´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`/api/stores/${storeId}/menus/${id}`, {
            method: "DELETE",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("ë³¸ì¸ ì†Œìœ ì˜ ê°€ê²Œë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                alert("ë©”ë‰´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeEditMenuModal();
                window.location.reload();
            })
            .catch(err => alert("ì˜¤ë¥˜: " + err.message));
    }

    function deleteStore() {
        if (!confirm("ì •ë§ ì´ ê°€ê²Œë¥¼ íì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`/api/stores/${storeId}`, {
            method: "DELETE",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("ë³¸ì¸ ì†Œìœ ì˜ ê°€ê²Œë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                alert("ê°€ê²Œê°€ íì—…ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = "/home.html"; // í˜¹ì€ ë©”ì¸ í˜ì´ì§€
            })
            .catch(err => alert("ì˜¤ë¥˜: " + err.message));
    }

    function openStoreEditModal() {
        document.getElementById("store-edit-modal").style.display = "block";
    }

    function openTimeEditModal() {
        document.getElementById("store-time-modal").style.display = "block";
    }

    function submitStoreEdit() {
        const body = {
            storeName: document.getElementById("edit-store-name").value.trim(),
            storeAddress: document.getElementById("edit-store-address").value.trim(),
            foodCategory: document.getElementById("edit-food-category").value.trim(),
            storePhone: document.getElementById("edit-store-phone").value.trim(),
            storeIntro: document.getElementById("edit-store-intro").value.trim(),
            minDeliveryPrice: parseInt(document.getElementById("edit-min-price").value),
            deliveryTip: parseInt(document.getElementById("edit-delivery-tip").value)
        };

        fetch(`/api/stores/${storeId}`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        })
            .then(res => res.json())
            .then(() => {
                alert("ê°€ê²Œ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById("store-edit-modal").style.display = "none";
                location.reload();
            })
            .catch(err => alert("ìˆ˜ì • ì‹¤íŒ¨: " + err.message));
    }

    function submitTimeEdit() {
        const body = {
            openTime: document.getElementById("edit-open-time").value.trim(),
            closeTime: document.getElementById("edit-close-time").value.trim()
        };

        fetch(`/api/stores/${storeId}/operating-time`, {
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        })
            .then(res => res.json())
            .then(() => {
                alert("ì˜ì—…ì‹œê°„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById("store-time-modal").style.display = "none";
                location.reload();
            })
            .catch(err => alert("ìˆ˜ì • ì‹¤íŒ¨: " + err.message));
    }

    function openMenuDetailModal(menuId, menuName, menuContent) {
        document.getElementById('detail-menu-name').innerText = menuName;
        document.getElementById('detail-menu-content').innerText = menuContent;
        document.getElementById('menu-detail-modal').style.display = 'block';

        // ì˜µì…˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        loadMenuOptions(menuId);
        setupOrderButton(menuId);
    }

    function closeMenuDetailModal() {
        document.getElementById('menu-detail-modal').style.display = 'none';
    }

    function loadMenuOptions(menuId) {
        const token = localStorage.getItem("accessToken");

        fetch(`/api/stores/${storeId}/menus/${menuId}/options`, {
            method: "GET",
            headers: { Authorization: "Bearer " + token }
        })
            .then(res => res.json())
            .then(result => {
                const options = result.data || [];

                const listDiv = document.getElementById('option-list');
                listDiv.innerHTML = '';

                if (options.length === 0) {
                    listDiv.innerHTML = "<p>ë“±ë¡ëœ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                } else {
                    options.forEach(option => {
                        listDiv.innerHTML += `
                <div style="border:1px solid #eee; border-radius:8px; padding:10px; margin-bottom:10px;">
                    <strong>${option.option_name}</strong> - ${option.price.toLocaleString()}ì›
                    <div style="font-size:0.9em; color:#666;">${option.content}</div>
                    ${isOwner ? `
                    <div style="margin-top:5px;">
                        <button onclick="openEditOptionModal(${menuId}, ${option.id}, '${option.option_name}', ${option.price}, '${option.content}')" style="padding:4px 8px; background:#ffa500; color:white; border:none; border-radius:6px; font-size:0.8rem;">ì˜µì…˜ ìˆ˜ì •</button>
                        <button onclick="submitOptionDelete(${menuId}, ${option.id})" style="padding:4px 8px; background:#dc3545; color:white; border:none; border-radius:6px; font-size:0.8rem;">ğŸ—‘ ì‚­ì œ</button>
                    </div>` : ''}
                </div>
                `;
                    });
                }

                const actionDiv = document.getElementById('option-action');
                if (isOwner) {
                    actionDiv.innerHTML = `<button onclick="openAddOptionModal(${menuId})" style="padding:8px 12px; background:#007bff; color:white; border:none; border-radius:6px;">â• ì˜µì…˜ ì¶”ê°€</button>`;
                } else {
                    actionDiv.innerHTML = '';
                }
            })
            .catch(err => {
                console.error("ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨", err);
                document.getElementById('option-list').innerHTML = '<p>ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨</p>';
            });
    }


    let currentAddingMenuId = null;

    function openAddOptionModal(menuId) {
        currentAddingMenuId = menuId;
        document.getElementById("add-option-name").value = "";
        document.getElementById("add-option-price").value = "";
        document.getElementById("add-option-content").value = "";
        document.getElementById("add-option-modal").style.display = "block";
    }

    function closeAddOptionModal() {
        document.getElementById("add-option-modal").style.display = "none";
    }

    function submitOptionAdd() {
        const token = localStorage.getItem("accessToken");
        const storeId = new URLSearchParams(window.location.search).get("storeId");
        const optionName = document.getElementById("add-option-name").value.trim();
        const price = parseInt(document.getElementById("add-option-price").value.trim(), 10);
        const content = document.getElementById("add-option-content").value.trim();

        if (!optionName || isNaN(price)) {
            alert("ëª¨ë“  í•„ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        const body = { optionName, price, content };

        fetch(`/api/stores/${storeId}/menus/${currentAddingMenuId}/options`, {
            method: "POST",
            headers: {
                Authorization: "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        })
            .then(res => {
                if (!res.ok) throw new Error("ë³¸ì¸ ì†Œìœ ì˜ ê°€ê²Œë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return res.json();
            })
            .then(() => {
                alert("ì˜µì…˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!");
                closeAddOptionModal();
                loadMenuOptions(currentAddingMenuId); // ì˜µì…˜ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            })
            .catch(err => alert("ì˜¤ë¥˜: " + err.message));
    }


    // ----

    let currentEditingMenuId;
    let currentEditingOptionId;

    function openEditOptionModal(menuId, optionId, name, price, content) {
        currentEditingMenuId = menuId;
        currentEditingOptionId = optionId;
        document.getElementById("edit-option-name").value = name;
        document.getElementById("edit-option-price").value = price;
        document.getElementById("edit-option-content").value = content;
        document.getElementById("edit-option-modal").style.display = "block";
    }

    function closeEditOptionModal() {
        document.getElementById("edit-option-modal").style.display = "none";
    }

    function submitOptionEdit() {
        const token = localStorage.getItem("accessToken");
        const storeId = new URLSearchParams(window.location.search).get("storeId");
        const optionName = document.getElementById("edit-option-name").value.trim();
        const price = parseInt(document.getElementById("edit-option-price").value.trim(), 10);
        const content = document.getElementById("edit-option-content").value.trim();

        if (!optionName || isNaN(price)) {
            alert("ëª¨ë“  í•„ë“œë¥¼ ì±„ì›Œì£¼ì„¸ìš”!");
            return;
        }

        fetch(`/api/stores/${storeId}/menus/${currentEditingMenuId}/options/${currentEditingOptionId}`, {
            method: "PATCH",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ optionName, price, content })
        })
            .then(res => {
                if (!res.ok) throw new Error("ë³¸ì¸ ì†Œìœ ì˜ ê°€ê²Œë§Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return res.json();
            })
            .then(() => {
                alert("ì˜µì…˜ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
                closeEditOptionModal();
                loadMenuOptions(currentEditingMenuId); // ì˜µì…˜ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            })
            .catch(err => alert("ì˜¤ë¥˜: " + err.message));
    }

    function submitOptionDelete(menuId, optionId) {
        const token = localStorage.getItem("accessToken");
        if (!confirm("ì •ë§ ì´ ì˜µì…˜ì„ ì‚­ì œí• ê¹Œìš”?")) return;

        fetch(`/api/stores/${storeId}/menus/${menuId}/options/${optionId}`, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + token }
        })
            .then(() => {
                alert("ì˜µì…˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadMenuOptions(menuId);
            })
            .catch(err => alert("ì˜µì…˜ ì‚­ì œ ì‹¤íŒ¨: " + err.message));
    }

    function setupOrderButton(menuId) {
        const orderButton = document.getElementById("order-button");
        orderButton.onclick = function() {
            const token = localStorage.getItem("accessToken");
            const storeId = new URLSearchParams(window.location.search).get("storeId");

            fetch(`/api/orders/${menuId}`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            })
                .then(res => {
                    if (!res.ok) throw new Error("ì£¼ë¬¸ ì‹¤íŒ¨");
                    return res.json();
                })
                .then(() => {
                    alert("ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    closeMenuDetailModal(); // ë©”ë‰´ ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
                })
                .catch(err => {
                    alert("ì£¼ë¬¸ ì‹¤íŒ¨: " + err.message);
                });
        }
    }

    function openOrderListPage() {
        const storeId = new URLSearchParams(window.location.search).get("storeId");
        // ì£¼ë¬¸ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™ (ìƒˆ í˜ì´ì§€ë¡œ)
        window.open(`/order-list.html?storeId=${storeId}`, "_blank", "width=800,height=600");
    }



</script>

</body>
</html>